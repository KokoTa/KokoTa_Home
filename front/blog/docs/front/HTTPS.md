# HTTPS

自2017年12月被放出来实习，至今也快有三个月了，有时候我在思考，自己到底在干什么，自己到底想干什么。我没有得出一个结论，我想大部分刚出社会的小baby们应该是都同样的想法。前端开发工程师，一个熟悉又陌生的名词。熟悉，是因为我正在从事相关的工作；陌生，是因为前端这个大坑“永无止境”。学习总是能让人豁然开朗，但是鲁迅说过：“学习不复习，知识记不住，知识记不住，等于没学习。”回头看看自己写的博客，感受颇多。我总是暗示自己得做学习总结，但总是三天打鱼两天晒网...地计划，em...  
工作使人增长经验，但似乎也仅限于此，许多的技术知识没法在工作中遇到，导致日积月累的记忆断层。果然，人就是人，不是电脑啊~~~  

## 什么是 HTTP

HTTP是什么？这个似乎不需要多说，它就是一个传输协议，位于应用层，一般用在web上。比如：浏览器给服务器发送信息，服务器回传响应，这个过程就需要用到HTTP和TCP/IP协议。  
这个协议看似很OK，但其实隐藏了很多安全问题：

1. 通信使用的是明文，即内容是对外公开的，谁截到请求，谁就能看到请求的内容。
2. 通信时不验证身份，顾名思义，可能导致中间人攻击。
3. 无法验证报文完整性，即我寄给你一个包裹，但你拿到的包裹可能是被快递小哥哥掉包的包裹

总体感觉就是“我在外面裸奔，裸奔的我，弱弱的我，我能被任何人按在地上摩擦”。

## 什么是 HTTPS

基于HTTP的弱点，广大人民群众想出了一个好方案来使HTTP安全化，后人称之为HTTPS。  
HTTPS = HTTP + 加密 + 认证 + 完整性保护 = HTTP + SSL/TLS  

### 加密

1. 共享密钥加密：客户端和服务器用同一个密钥加密和解密信息，但这有一个大问题：如何把这个密钥传给没有密钥的一方？要是被中间人截取了，那这个加密就形同虚设了。
2. 公钥私钥加密：即两把密钥，公钥发给你(用于加密)，私钥留自己(用于解密)。公钥随便给，反正解密的权利在我手上，这样就解决了中间人问题，反正拿了公钥也解密不了信息。
3. 证书的签名和验证：和公钥私钥同理，私钥(签发机构给的)负责签名，公钥(浏览器内置的)负责验证。

### 证书

通过加密，安全问题就解决了吗？NONONO！这里还存在一个严重问题：你怎么知道我发给你的公钥是我的公钥呢？会不会是被别人截取后替换的公钥呢？  
这个问题交给证书吧，它可以保证公钥的合法性。（然而还是不能完全保证，比如签发机构自身出事了）  
证书类似公钥的身份证，由可信任的第三方公司（认证公司）颁发，使用证书的流程如图：
![数字证书](/images/数字证书.jpg)

### 完整性保护

HTTPS情况下，应用层发送数据时会附加一种叫做MAC(Message Authentication Code)的报文摘要，可以查知报文是否被篡改，从而保证了报文完整性。

## HTTPS通信流程

![HTPPS流程](/images/HTTPS流程.jpg)

1. 客户端发送 Client Hello，表示要开始 SSL 通信。报文中包含 SSL 版本、支持的加密算法等。
2. 服务端发送 Server Hello，表示可以进行 SSL 通信。报文中包含具体的 SSL 版本、选择的加密算法等。
3. 服务器发送 Certificate，即发送公钥证书
4. 服务器发送 Server Hello Done，通知客户端SSL第一次握手结束
5. 客户端发送 Client Key Exchange，发送由客户端生成的 pre-master secret(一串随机数)，该随机数利用步骤 3 的公钥加密
6. 客户端发送 Change Cipher Spec，表示后续的通讯会用这个随机数来进行加密
7. 客户端发送 Finished，包含连接至今全部报文的整体校验值，如果服务器解密成功，则该次握手成功
8. 行为和6同理
9. 行为和7同理
10. SSL建立完成，开始进行HTTP请求
11. HTTP响应
12. 客户端断开连接

这里我们可能会有一个问题，把证书克隆一份，其他人是不是也能拥有沟通权限了？
答案是否定的，原因见 [这里](https://www.zhihu.com/question/29251991/answer/580813797)
