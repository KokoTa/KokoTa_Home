<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>服务端踩坑日记 | KokoTa&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/KokoTa_Home/assets/css/0.styles.42391945.css" as="style"><link rel="preload" href="/KokoTa_Home/assets/js/app.5aa2fc63.js" as="script"><link rel="preload" href="/KokoTa_Home/assets/js/2.f316d9e6.js" as="script"><link rel="preload" href="/KokoTa_Home/assets/js/21.189a1078.js" as="script"><link rel="prefetch" href="/KokoTa_Home/assets/js/10.a9408bab.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/11.afe9acb0.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/12.20b684e8.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/13.96a14a48.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/14.7fbab43c.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/15.c94cf8e5.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/16.636c15bf.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/17.61b345d1.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/18.6438c8af.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/19.a7367e7f.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/20.afbf2002.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/22.024a4a11.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/23.781c0901.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/24.25347c92.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/25.713bc585.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/26.84be1e5d.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/27.a914d101.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/28.cc74e010.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/29.8c624b89.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/3.137d0a24.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/30.db83752a.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/31.8a4e8fdb.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/32.27e1eac7.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/33.49f44af8.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/34.242d9c41.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/35.2da8abc4.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/36.8e90cb74.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/37.ddbb7313.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/38.46018d6a.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/39.126f7b49.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/4.a018097d.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/40.52371e0b.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/41.dc35554b.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/42.90cf799c.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/43.417fb137.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/44.b5b86393.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/45.62db7fc8.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/46.33329211.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/47.5dd730b0.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/48.8bf9775b.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/49.4aa4884e.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/5.f4fd9258.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/6.768d9e6b.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/7.37408dde.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/8.34002bbc.js"><link rel="prefetch" href="/KokoTa_Home/assets/js/9.e96cfb2c.js">
    <link rel="stylesheet" href="/KokoTa_Home/assets/css/0.styles.42391945.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/KokoTa_Home/" class="home-link router-link-active"><!----> <span class="site-name">KokoTa's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/KokoTa_Home/front/" class="sidebar-heading clickable router-link-active open"><span>旧文章迁移</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/KokoTa_Home/front/盒模型与BFC与布局.html" class="sidebar-link">盒模型与BFC与布局</a></li><li><a href="/KokoTa_Home/front/事件与类型.html" class="sidebar-link">事件与类型</a></li><li><a href="/KokoTa_Home/front/HTTP.html" class="sidebar-link">HTTP</a></li><li><a href="/KokoTa_Home/front/原型.html" class="sidebar-link">原型</a></li><li><a href="/KokoTa_Home/front/类与继承.html" class="sidebar-link">类与继承</a></li><li><a href="/KokoTa_Home/front/通信与安全.html" class="sidebar-link">通信与安全</a></li><li><a href="/KokoTa_Home/front/渲染与运行与性能与监控.html" class="sidebar-link">渲染与运行与性能与监控</a></li><li><a href="/KokoTa_Home/front/HTTPS.html" class="sidebar-link">HTTPS</a></li><li><a href="/KokoTa_Home/front/Cookie与Session与Token.html" class="sidebar-link">Cookie与Session与Token</a></li><li><a href="/KokoTa_Home/front/跨域.html" class="sidebar-link">跨域</a></li><li><a href="/KokoTa_Home/front/移动端适配.html" class="sidebar-link">移动端适配</a></li><li><a href="/KokoTa_Home/front/JS精度问题.html" class="sidebar-link">JS精度问题</a></li><li><a href="/KokoTa_Home/front/服务端踩坑日记.html" class="active sidebar-link">服务端踩坑日记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#购买服务器" class="sidebar-link">购买服务器</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#远程登录和免密登录" class="sidebar-link">远程登录和免密登录</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#切换用户和角色创建" class="sidebar-link">切换用户和角色创建</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#限定端口和登录权限" class="sidebar-link">限定端口和登录权限</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#增强服务器安全等级" class="sidebar-link">增强服务器安全等级</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#环境搭建" class="sidebar-link">环境搭建</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#nginx反向代理" class="sidebar-link">Nginx反向代理</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#域名解析及数据库安装" class="sidebar-link">域名解析及数据库安装</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#数据库数据同步和数据库权限" class="sidebar-link">数据库数据同步和数据库权限</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#数据库备份" class="sidebar-link">数据库备份</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#项目部署" class="sidebar-link">项目部署</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#番外1-ssl证书的获取与应用" class="sidebar-link">番外1：SSL证书的获取与应用</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#番外2-连接远程数据库" class="sidebar-link">番外2：连接远程数据库</a></li><li class="sidebar-sub-header"><a href="/KokoTa_Home/front/服务端踩坑日记.html#番外3-连接远程服务器" class="sidebar-link">番外3：连接远程服务器</a></li></ul></li><li><a href="/KokoTa_Home/front/前端问题汇总.html" class="sidebar-link">前端问题汇总</a></li><li><a href="/KokoTa_Home/front/微信开发.html" class="sidebar-link">微信开发</a></li><li><a href="/KokoTa_Home/front/JS的this.html" class="sidebar-link">JS的this</a></li><li><a href="/KokoTa_Home/front/缓存.html" class="sidebar-link">缓存</a></li><li><a href="/KokoTa_Home/front/MVVM.html" class="sidebar-link">MVVM</a></li><li><a href="/KokoTa_Home/front/混合开发.html" class="sidebar-link">混合开发</a></li><li><a href="/KokoTa_Home/front/直播.html" class="sidebar-link">直播</a></li><li><a href="/KokoTa_Home/front/内网穿透.html" class="sidebar-link">内网穿透</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/KokoTa_Home/question/" class="sidebar-heading clickable"><span>前端知识汇总</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="服务端踩坑日记"><a href="#服务端踩坑日记" class="header-anchor">#</a> 服务端踩坑日记</h1> <p>前端写了这么久，却还只是停在本地服务器开发，云服务器什么的我才不懂嘞~<br>
噢，我知道这样子是不对的，正好赶上腾讯云打折，就买了台服务器自己玩一下吧。<br>
然而买完之后有点后悔了，阿里云居然也打折了，同样的配置，更低的价格。。。我想这一定是服务器商的阴谋！<br>
接着我的表情逐渐扭曲。。。<br>
A few moments later。。。<br>
接着我的表情逐渐稳定。。。<br>
转移注意力思考了一下人生。。。
想想看啊，实习也快结束了，回顾了一下自己写的东西。。。
FUCK！看来以后要叫我“Bug Boy”了，哈哈哈哈！我Bug多！我开心！我自豪！我。。。(忧郁脸)<br>
好吧，现实把我拉了回来，且不论自己懒癌有没有得治，放着买好的服务器不用，这不是暴殄天物吗？<br>
我拍着自己的肚皮，怀着刚刚给自己加冕为王时的尴尬心情，深思熟虑了5秒钟。。。
我决定试试把一张页面放到服务器上，嘻嘻！</p> <h2 id="购买服务器"><a href="#购买服务器" class="header-anchor">#</a> 购买服务器</h2> <p>这个就不用过多阐述了，阿里云、腾讯云、百度云等服务器提供商都可以购买云服务器。一般来说1核1G的服务器可以同时应付几百人同时在线，对于我来说，这已经足够了。购买服务器时，个人推荐ubuntu的系统，对新手(我)比较友好。购买后，我们会收到购买成功的邮件，邮件里是服务器的信息，包括服务器的公网IP和密码。接着我们打开云服务器控制台：<br> <img src="/images/server-build/%E4%BA%91%E4%B8%BB%E6%9C%BA%E6%8E%A7%E5%88%B6%E5%8F%B0.png" alt="云主机控制台"><br>
我们可以看到右侧有个登录按钮，点击进入后输入ubuntu(默认用户名)和密码(邮件里的)，我们就可以登录系统控制台了。</p> <h2 id="远程登录和免密登录"><a href="#远程登录和免密登录" class="header-anchor">#</a> 远程登录和免密登录</h2> <p>虽然我们可以以网页线上的方式登录控制台，但是需要先进入官网啊，再进入控制台啊，再选择服务器登录啊等等，很麻烦。所以我们一般都是本地登录，这里需要用到Linux命令行工具。如果是Mac用户，可以用自带的shell来执行命令，这里由于本人是吃土少年，只有Windows，所以想要执行Linux命令，就需要额外的辅助工具(比如Putty、bash)。谢天谢地，幸好我有使用git，自带了bash命令行工具，懒癌+1。</p> <p>打开命令行工具后，我们输入 <code>ssh ubuntu@公网IP</code> 后，再输入密码，就可以登录服务器系统控制台了。(PS：输入密码时没有光标，也不会显示输入的字符，但确实是输入进去了，Linux大佬会心一笑)<br>
好的，现在我们可以愉快的进行操作了，但每次登录都要输密码，确实是件麻烦事，懒癌+1，可不可以自动登录啊喂？</p> <p>当然可以！这里的思路和<a href="https://help.github.com/articles/connecting-to-github-with-ssh/" target="_blank" rel="noopener noreferrer">Github SSH Key<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类似，只要把本地生成的公钥传过去就可以了。<br>
首先我们要查看本地有没有钥匙 <code>ls -al ~/.ssh</code><br>
如果有钥匙，如下图，<code>id_rsa</code> 是私钥，<code>id_rsa.pub</code> 是公钥：<br> <img src="/images/server-build/%E6%A3%80%E6%9F%A5%E9%92%A5%E5%8C%99.png" alt="检查钥匙"><br>
如果没有钥匙，那我们就生成呗，输入 <code>cd ~/.ssh</code> 回车进入 <code>.ssh</code> 文件夹，然后再输入 <code>ssh-keygen -t rsa -b 4096 -C &quot;your_email@example.com&quot;</code> 疯狂回车，钥匙就生成啦。<br>
接着我们进入服务器控制台，输入 <code>ls -a</code>，检查有没有 <code>.ssh</code> 文件夹，没有就 <code>mkdir .ssh</code> 创建，然后 <code>cd .ssh</code> 进入该文件夹。<br>
OK，现在我们需要在 <code>.ssh</code> 文件夹中创建一个文件名为 <code>authorized_keys</code> 的文件。输入 <code>touch authorized_keys</code> 创建，打开本地的公钥文件(id_rsa.pub)，复制里面的内容，将视线转移回服务器控制台，输入 <code>vi authorizaed_keys</code>，利用 <code>vim(编辑器)</code> 打开文件，输入 <code>i</code>，开启插入模式，将公钥内容复制进去，然后 <code>Esc</code> 退出输入模式，再按下 <code>shift+:</code>，输入 <code>wq!</code> 保存文件，输入 <code>chmod 600 authorizaed_keys</code> 对文件进行权限升级。<br>
最后输入 <code>scp id_rsa.pub 用户名@公网IP:authorized_keys</code> 进行上传，<code>service ssh restart</code> 重启连接后再进入时就可以实现某个用户的免密了！</p> <h2 id="切换用户和角色创建"><a href="#切换用户和角色创建" class="header-anchor">#</a> 切换用户和角色创建</h2> <p>登录完成了，我想看看服务器信息，于是我输入了 <code>fdisk -l</code>，返回了 <code>fdisk: cannot open /dev/vda: Permission denied</code>。很好，我没有权限，这咋整？<br>
Ubuntu 这个家伙并不是老大，root 才是最终 BOSS，我们可以利用 root 来进行某些高级权限操作。<br>
转换角色的方法很简单，就是输入 <code>su root</code>，然后输入密码就可以了，默认密码就是 Ubuntu 的密码。<br>
哼哼~，现在我们可以用 <code>fdisk -l</code> 查看磁盘信息了。</p> <p>但不久后问题来了，root 懒癌晚期不想动了，想把高级操作授权给其他人，这怎么操作？<br>
Don't mind，首先我们要创建 manager 这个用户，<code>adduser manager</code>；然后使 manager 有使用 sudo 命令的权限，<code>gpasswd -a manager sudu</code>；接着用 vim 打开 sudo 配置文件，<code>sudo visudo</code>；赋予与 root 一样的配置，如下图：<br> <img src="/images/server-build/%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE.png" alt="用户权限配置"><br>
退出后我们的 manager 就可以以 <code>sudo 命令</code> 的方式来执行只有 root 才能执行的操作了。</p> <h2 id="限定端口和登录权限"><a href="#限定端口和登录权限" class="header-anchor">#</a> 限定端口和登录权限</h2> <p>默认情况下，我们连接的是 22 端口，也就是说我买了服务器，全世界的人都知道我默认连的 22 端口。这可不太对啊，我得把这个端口改掉。<br>
输入 <code>sudo vi /etc/ssh/sshd_config</code> 打开配置文件，根据 vim 的方式修改端口：<br> <img src="/images/server-build/%E4%BF%AE%E6%94%B9%E7%AB%AF%E5%8F%A3.png" alt="修改端口"><br>
然后设置允许哪些用户可以登录，见下图，添加 <code>AllowUsers manager</code>，允许 manager 可以登录。<br>
这样我们只能以 <code>ssh -p 39999 manager@公网IP</code> 这种方式才能登录控制台了。</p> <p>默认情况下，我们服务器的最大 BOSS 是 root，也就是说我买了服务器，全世界的人都知道我 root 可以打爆所有人的狗头。这可不太对啊，我得限制他登录，不然被人窃用了可完蛋了。<br>
还是同样的配置文件，修改地方如下：<br> <img src="/images/server-build/%E4%BF%AE%E6%94%B9%E7%99%BB%E5%BD%95%E6%9D%83%E9%99%90.png" alt="修改登录权限"><br> <code>PermitRootLogin no</code> 不允许 root 登录<br> <code>UseDNS no</code> 不让DNS，防止被DNS查找窃取<br> <code>PasswordAuthentication no</code> 不进行密码登录，因为我们已经在本地配置了无密码登录，也就是说设置后只有我才能登录，就算有密码别人也登录不了。<br>
最后，换电脑时千万注意要进行钥匙的备份，否则就永远登不进服务器了(因为禁用了密码登录= =)。也可以在新电脑上新建钥匙后，传给旧电脑，让旧电脑授权新电脑。</p> <h2 id="增强服务器安全等级"><a href="#增强服务器安全等级" class="header-anchor">#</a> 增强服务器安全等级</h2> <p>根据上面的方法，我们实现了基本的服务器安全配置，但这远远不够，我们再加点东西。<br>
这里我们使用了 iptables 防火墙框架(服务器自带)，它的作用是限制登录的方式(http/https/ssh)、拦截异常访问(比如一段时间内超多次连接)、打印拦截Log等。<br>
首先升级一下 Ubuntu 系统 <code>sudo apt-get update &amp;&amp; sudo apt-get upgrade</code>，然后清空 iptables 的配置(默认就是没有配置) <code>sudo iptables -F</code><br>
接着我们创建 iptables 的配置文件 <code>sudo vi /etc/iptables.up.rules</code>，然后输入信息如图：<br> <img src="/images/server-build/iptables%E9%85%8D%E7%BD%AE1.png" alt="iptables配置1"> <img src="/images/server-build/iptables%E9%85%8D%E7%BD%AE2.png" alt="iptables配置2">
保存文件后，让配置关联到 iptables 上，<code>sudo iptables-restore &lt; /etc/iptables.up.rules</code>，如果没有报错，说明 iptables 配置成功。<br>
然后我们输入 <code>sudo ufw status</code> 观察防火墙是否开启，如果木有开启，就输入 <code>sudo ufw enable</code> 打开。<br>
OK，防火墙设置完毕。(PS: 设置配置后最好不要关闭连接，而是新建终端登录，因为如果手残改错了配置，进不去服务器，还可以用已经连接的终端进行配置修改，否则。。。)<br>
不过有个小问题，如果服务器重启了，防火墙就需要手动重启了，我们写个配置文件来自动打开防火墙，懒癌+1，输入 <code>sudo vi /etc/network/if-up.d/iptables</code>，增加 <code>#!/bin/sh</code> 和 <code>iptables-restore /etc/iptables.up.rules</code> 字段，最后修改执行权限，让它开机后执行，控制台输入 <code>sudo chmod +x /etc/network/if-up.d/iptables</code> 后就可以了。</p> <p>为了根据系统日志执行不同操作，这里用到了fail2ban库，一个防御性动作库。<br> <code>sudo apt-get install fail2ban</code> 安装后，通过 <code>sudo vi /etc/fail2ban/jail.conf</code> 打开它的配置文件，修改 destemail 为自己的邮箱(这里我是用QQ邮箱)，然后修改 action 为 <code>%(action_mw)s</code>。<br>
最后我们检查下 fail2ban 运行了木有 <code>sudo service fail2ban status</code>，通过 <code>sudo service fail2ban start/stop</code> 开关它。</p> <p>就这样，我们的安全配置就告一段落了，当然了，这些还只是基础配置(认真脸)。</p> <h2 id="环境搭建"><a href="#环境搭建" class="header-anchor">#</a> 环境搭建</h2> <p>好的，现在我们开始搭建服务器环境，由于是前端，就用我最熟悉的Node吧，嘻嘻。<br>
首先我们要在服务器系统中安装一些包：<code>sudo apt-get install vim openssl build-essential libssl-dev wget curl git</code>。<br> <code>vim/git</code> 就不用说了；<code>wget/curl</code>可以当作服务端的 npm，用来下载资源；<code>openssl build-essential libssl-dev</code>用来构建HTTPS。　　
然后下载 <code>nvm</code>：<code>wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash</code>。<br>
接着利用 <code>nvm</code> 来安装 Node <code>nvm install Node版本</code>，应用 Node 到命令行上 <code>nvm use Node版本</code>，设置命令行上 Node 的默认版本 <code>nvm alias default Node版本</code>(可省略此步)。<br>
由于 npm 比较慢，所以可以用淘宝的 cnpm 下载东西，cnpm 用的源是国内的，因此会比较块，让我们安装 cnpm <code>npm install -g cnpm --registry=https://registry.npm.taobao.org</code>。<br>
最后我们增加一下环境监控树，<code>echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf &amp;&amp; sudo sysctl -p</code>。</p> <p>OK，环境就这样搭建好了，然后我们测试一下，在服务端写一个app.js(内容就是Node官网的简单示例)，监听端口为8081，保存文件后输入<code>node app</code>，打开浏览器输入公网IP和端口号，激动人心的时刻到了！<br>
。。。<br>
。。。<br>
该网页无法正常运作。。。<br>
嗯？怎么回事？？？<br>
经过一番思索后，原来是 iptables 的配置没有允许 8081 端口啊。<br>
于是我们 <code>sudo vi /etc/iptables.up.rules</code> 打开文件并添加 8081 接口保存后，<code>sudo iptables-restore &lt; /etc/iptables.up.rules</code> 关联后就可以该端口的访问了。</p> <p>OK，网页可以正常显示了，但是问题来了：当我把终端关闭时，就等于是关闭 Node 应用了，有木有办法可以实现离线挂载？<br>
当然有，我们可以使用 <code>pm2</code> 这个包，它可以自动帮我们运维服务器。<br>
使用 npm 下载 <code>pm2</code> 后，直接输入 <code>pm2 start app.js</code> 启动服务，通过 <code>pm2 list</code> 查看列表、<code>pm2 show app</code> 查看详细信息、<code>pm2 logs</code> 查看日志。</p> <p>OK，即使关掉终端，我们的服务也会继续跑，真棒！但是问题又来了：一般访问网站都是直接输入网站IP或域名，但是我们还需要显示输入端口(8081)。<br>
我们的 manager 用户没有权限去操作 80 端口(0 - 1024 端口只有 root 可以操作，然而我们把 root 关起来了= =)，这可咋整咯？<br>
哼哼~我们可以用Nginx啊！</p> <h2 id="nginx反向代理"><a href="#nginx反向代理" class="header-anchor">#</a> Nginx反向代理</h2> <p>这家伙的作用如图：<br> <img src="/images/server-build/Nginx%E4%BD%9C%E7%94%A8.png" alt="Nginx作用">
由于购买服务器可能默认带有 apache2，因此首先要把它删掉， 先停止 <code>sudo service apache2 stop</code>，后删除 <code>sudo update-rc.d -f apache2 remove</code>。<br>
更新一下包列表 <code>sudo apt-get update</code>。<br>
安装 Nginx <code>sudo apt-get install nginx</code>。<br>
进入 Nginx 配置文件夹 <code>cd /etc/nginx/conf.d</code>。<br>
创建并编辑自定义配置文件(文件名可以按示例这个格式) <code>sudo vi kokota-cn-8081.conf</code>，编辑内容如下:<br> <img src="/images/server-build/Nginx%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE.png" alt="Nginx自定义配置">
然后我们返回到 nginx 这个目录，打开主配置文件 <code>nginx.conf</code>，检查是否有 <code>include /etc/nginx/conf.d/*.conf;</code>，此项意味着会把所有自定义配置都加载进来。<br>
现在我们检查并进行 Nginx 配置 <code>sudo nginx -t</code>，成功后重启 Nginx <code>sudo nginx -s reload</code>，然后就可以愉快的进行访问啦。<br>
PS：访问网站时，响应头信息会有 <code>Server: nginx/1.10.3 (Ubuntu)</code> 为了安全考虑可以隐藏它的版本和系统，操作的话我们打开主配置文件 <code>nginx.conf</code> 然后将 <code># server_tokens off;</code> 这个注释取消掉就口以了。</p> <h2 id="域名解析及数据库安装"><a href="#域名解析及数据库安装" class="header-anchor">#</a> 域名解析及数据库安装</h2> <p>我们知道，一个域名只能对应一个IP，而一个IP可以对应多个域名。<br>
现在我们有了域名了，就得想办法让用户以域名的方式访问网站。<br>
这时我们就需要用到 <code>DNS 解析了</code>，DNS 解析简单来说就是把域名解析成域名对应的公网IP。<br>
一般来说我们直接使用厂商的 DNS 解析服务就可以了，比如这里我使用的是腾讯云。<br>
解析的设置也很简单：进入腾讯云网站 -&gt; 域名服务 -&gt; 解析。</p> <p>解析的时候需要选择类型，一般来说我们只要知道 4 种类型即可：</p> <ol><li>A：域名映射到IP，是常用的类型。</li> <li>CNAME：域名映射到其他域名，比如七牛云的域名对应多个IP，我们没法让自己的域名对应七牛云的IP，此时我们只要设置CNAME，让自己的域名映射到七牛云的域名，就可以让七牛云去解析IP了。</li> <li>MX：填写邮件服务器的域名或IP。</li> <li>TXT：用于企业邮箱的反垃圾设置。</li></ol> <p>除了类型，还有权重，即解析时重叠了多个规则，规则的优先级。<br>
这里我们先添加一个 <code>www</code> 的规则，即访问 <code>www.kokota.cn</code> 会对应到这个规则上。<br>
当然，我们还可以设置多个子域名，服务器通过不同子域名来分配不同的服务。<br>
DNS 的服务器有很多，比较权威的是 DNSPod，我们在 域名服务 里点击域名后可以看到域名详细信息，这里有一个 DNS 服务器的信息，我们可以看到腾讯云使用的就是 DNSPod。<br> <img src="/images/server-build/%E5%9F%9F%E5%90%8D%E4%BF%A1%E6%81%AF.jpg" alt="域名信息"></p> <p>这里介绍一下上面利用CNAME来映射七牛云：<br>
首先进入七牛云控制台，点击右侧自定义域名。<br> <img src="/images/server-build/%E4%B8%83%E7%89%9B%E4%BA%91%E6%98%A0%E5%B0%84.jpg" alt="七牛云映射">
填写 <code>加速域名</code> 为腾讯云中添加的二级域名(xx.kokota.cn)，其他选项选默认就好。<br>
然后我们从七牛云中进入这个新加的域名，点击右侧 <code>如何配置CNAME</code>。<br> <img src="/images/server-build/%E4%B8%83%E7%89%9B%E4%BA%91%E6%98%A0%E5%B0%842.jpg" alt="七牛云映射2">
复制该位置粉色字体后面的地址，这个地址就是CNAME解析时的地址。<br> <img src="/images/server-build/%E4%B8%83%E7%89%9B%E4%BA%91%E6%98%A0%E5%B0%843.jpg" alt="七牛云映射3">
然后将该值添加到对应的二级域名的记录值中即可。<br> <img src="/images/server-build/%E4%B8%83%E7%89%9B%E4%BA%91%E6%98%A0%E5%B0%844.jpg" alt="七牛云映射4"></p> <p>好了，通过上面步骤我们把域名对应到了公网IP，但此时我们还无法通过域名进行访问，因为我们的服务器还没处理通过域名访问的情况。不过在解决问题之前，我们先来安装一下数据库，这里使用的是MongoDB。通过 <a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/" target="_blank" rel="noopener noreferrer">MongoDB 安装文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 我们可以很方便的就安装好数据库。下载的时候可能会失败，很有可能是下载源的问题，可以打开 <code>/etc/apt/apt.conf</code> 把内容注释掉后再重新走一遍文档流程看看。</p> <p><strong>PS</strong>：通常来说需要两台服务器，一台放应用，一台放数据，这里由于自己是吃土少年，所以就把应用和数据都放在同一个服务器上了。</p> <p>OK，按文档走到第四步时，我们可能会发现，下载速度好慢！这是因为我们默认的源是 MongoDB 官网的源，你懂的，外网环境。所以如果实在等不了，我们就可以尝试切换 MongoDB 的下载源。通过进入 <code>/etc/apt/sources.list.d</code> 打开 <code>mongodb-org-3.6.list</code> 文件，修改源为 <code>mirrors.aliyun.com/mongodb/apt/ubuntu</code>，就可以快速下载啦！</p> <p>下载完成，根据文档启动 MongoDB，然后我们输入 <code>mongo</code> 来看看是否启动了数据库。<br>
此时我们会发现我们无法连接到数据库，因为我们的防火墙没有允许本地连接 <code>27017</code> 这个端口，我们需要修改防火墙配置。<br>
打开 iptables 配置文件， <code>sudo vi /etc/iptables.up.rules</code>，然后在 <code># accept ping ...</code> 这条规则后面添加新配置</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># accept mongodb connect</span>
<span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-s</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> tcp --destination-port <span class="token number">27017</span> <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> NEW,ESTABLISHED <span class="token parameter variable">-j</span> ACCEPT
<span class="token parameter variable">-A</span> OUTPUT <span class="token parameter variable">-d</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> tcp --destination-port <span class="token number">27017</span> <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> NEW,ESTABLISHED <span class="token parameter variable">-j</span> ACCEPT
</code></pre></div><p>然后关联配置， <code>sudo iptables-restore &lt; /etc/iptables.up.rules</code>。<br>
接着我们再次输入 <code>mongo</code>，连接成功！</p> <p>OK，但问题来了，全世界的人都知道 MongoDB 默认连接的就是 27017 端口，我们需要修改这个端口。<br>
打开 MongoDB 配置文件， <code>sudo vi /etc/mongod.conf</code>，修改端口后保存，同理，iptables 的配置也需要修改、关联。<br>
搞定后我们不能用 <code>mongo</code> 来连接，因为这个指令是简化版的，是连接 27017 端口的，我们需要输入 <code>mongo --port 端口号</code> 来进行连接。<br>
好了，我们现在完成了数据库的安装和连接了！</p> <h2 id="数据库数据同步和数据库权限"><a href="#数据库数据同步和数据库权限" class="header-anchor">#</a> 数据库数据同步和数据库权限</h2> <p>OK，数据库是连上了，但是这个数据库是空的，我们如何将本地数据同步到线上呢？<br>
MongoDB 等数据库是支持数据导入的，基本思想就是：本地数据打包成压缩包 -&gt; 上传到服务器 -&gt; 服务器解压 -&gt; 解压文件导入数据库。<br>
这里介绍两种导入方式，一种是数据库级别的导入，一种是表单级别的导入：</p> <ol><li>数据库级别：首先我们备份本地的数据库数据，输入 <code>mongodump -h 127.0.0.1:27017 -d 数据库名 -o 输出文件夹名</code>，执行后在输出文件夹中可以看到多个文件。接着我们利用Linux的压缩指令将这些文件进行压缩，输入 <code>tar zcvf xx.tar.gz 资源文件夹名</code> 后我们得到一个压缩包。然后我们利用 <code>scp</code> 命令将包上传到服务器，输入 <code>scp -p 39999 压缩包路径 manager@xxx.xx.xxx.x:目录</code> 将压缩包传输到指定目录。现在目录上就有该压缩包了，利用Linux的命令进行解压缩 <code>tar xvf xx.tar.gz</code> 后我们就拿到了备份的数据了。最后我们将数据导入到数据库中 <code>mongorestore -h 127.0.0.1:19999 -d 数据库名 数据所在的目录</code>。<a href="http://www.runoob.com/mongodb/mongodb-mongodump-mongorestore.html" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>表单级别：首先执行 <code>mongoexport -h 127.0.0.1:27017 -d 数据库名 -c 表名 -q 查询字符串 -o 资源导出路径(./xx.json)</code>(可以通过 <code>subl 文件名</code> 打开 sublime 查看该文件内容是否正确)，导出想要的数据到文件。然后将这个文件按上一方法进行上传后，输入 <code>mongoimport -h 127.0.0.1:19999 -d 数据库名 -c 表单名 资源文件路径(./xx.json)</code> 将数据导入进数据库。</li></ol> <p><strong>PS</strong>：这里我们是导入，而不是重写覆盖。<br> <strong>PS</strong>：如果要同步本地数据，最好在新建数据库后，在没有角色权限的情况下进行同步，这样可以省去输入用户名、密码等繁琐的步骤。<br> <strong>PS</strong>：如果想同步某服务器的数据到另一台服务器，步骤为：服务器A数据打包 -&gt; 下载到本地 -&gt; 和同步本地数据一样的操作...。<br> <strong>PS</strong>：如果要删除数据库，只要在系统终端输入 <code>mongo -h 127.0.0.1:19999 数据库名 --eval &quot;db.dropDatabase()&quot;</code> 即可(当然也可以进入数据库终端再进行删除)。</p> <p>OK，数据同步完成了，但新的问题也接踵而至：数据库权限问题。我们的数据库中存放着多个应用的数据，如果不进行权限控制，那么各个应用的数据任何人能操作，后果不堪设想。<br>
MongoDB 一开始是没有用户这一说的，我们首先得创建一个管理员，然后这个以这个管理员的身份进行其他角色的创建授权，我们让角色只拥有单个应用的权限。<br>
首先我们得进入数据库终端，输入 <code>use admin</code>，切换到 admin 数据库。<br>
然后通过以下代码格式创建一个管理员:<br> <img src="/images/server-build/%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E5%91%98.jpg" alt="创建管理员">
创建成功后我们使用 <code>db.auth(用户名，密码)</code> 的形式进行授权操作，返回值为 1 说明授权成功，现在我们的身份就是管理员了。</p> <p>然后我们以这个身份切换到别的数据库来创建角色。<br>
通过以下代码格式创建角色：<br> <img src="/images/server-build/%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2.jpg" alt="创建角色">
注意 <code>role</code> 这个参数，顾名思义，管理员可以管理所有数据库，角色可以细分为 读写、只读 等。<br>
建议创建一个具有读写角色和一个具有只读的角色。<br>
OK，现在我们就在这个数据库下创建了两个角色了。<br>
现在我们切换回 admin 数据库，再次进行 <code>db.auth(用户名，密码)</code> 授权管理员后，就可以同理进行其他数据库的角色创建了。</p> <p>角色创建完毕后，我们得开启验证模式。通过 <code>sudo vi /etc/mongod.conf</code> 打开配置文件，修改如下：<br> <img src="/images/server-build/%E6%89%93%E5%BC%80%E9%AA%8C%E8%AF%81%E6%A8%A1%E5%BC%8F.jpg" alt="打开验证模式">
然后重启数据库来更新配置。<br>
现在我们进入数据库，输入 <code>show dbs</code> 会报错，这说明了我们没有权限，我们需要获得身份进行操作。<br>
比如我们想以管理员身份操作，那就进入 admin 数据库，使用 <code>db.auth(用户名，密码)</code> 来授权身份为管理员。<br>
OK，现在我们是管理员了！</p> <p><strong>PS</strong>: <code>mongo 127.0.0.1:19999/数据库名 -u 用户 -p 密码</code> 可以直接以某用户登录某数据库。</p> <h2 id="数据库备份"><a href="#数据库备份" class="header-anchor">#</a> 数据库备份</h2> <p>众所周知，我们需要备份数据，否则天知道哪天数据库爆炸了？<br>
备份数据只要使用 <code>mongodump ...</code> 这个方法就可以了，不过每次都手动备份、压缩、存储，是非常麻烦的。<br>
我们可以编写一个脚本来执行备份操作，并且也可以利用自动执行脚本工具每个一段时间自动执行备份。</p> <p>OK，现在我们来开始编写备份脚本。<br>
我个人是在根目录下创建了个 tasks 文件夹，创建脚本文件 <code>vi ./tasks/talk.backup.sh</code>。<br>
内容如下，基本思想就是：创建临时文件夹 -&gt; 导出数据到临时文件夹 -&gt; 将临时文件夹进行压缩打包 -&gt; 删除临时文件夹<br> <img src="/images/server-build/%E8%87%AA%E5%8A%A8%E5%A4%87%E4%BB%BD%E8%84%9A%E6%9C%AC.jpg" alt="自动备份脚本">
写完脚本后我们可以输入 <code>sh ./tasks/talk.backup.sh</code> 来执行脚本，执行后检查是否有数据压缩包。</p> <p>OK，脚本写好了，现在我们要让它每过一段时间执行一次。<br>
通过 <code>crontab -e</code> 打开系统任务配置文件。<br>
添加时间任务如下：<br> <img src="/images/server-build/%E6%97%B6%E9%97%B4%E4%BB%BB%E5%8A%A1.jpg" alt="时间任务">
然后 <code>ctrl + x</code> <code>shift + Y</code> <code>enter</code> 进行保存。</p> <p>OK，我们完成了自动执行备份脚本的功能了，但我们备份时最好本地有一份，别的服务器也有一份。<br>
这里我们可以用文件上传的方式把备份上传到七牛云。<br>
首先安装七牛云的 npm 包 <code>npm i qiniu</code>。<br>
然后打开七牛云网站的 <code>Node SDK</code>，复制 <code>文件上传</code> 的代码，修改对应参数后，保存为文件(比如 <code>upload.js</code>)。<br>
然后添加执行该上传操作的命令到自动备份脚本，格式类似：<br> <img src="/images/server-build/%E4%B8%83%E7%89%9B%E4%BA%91%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6.jpg" alt="七牛云上传文件">
这样我们就可以将压缩包上传到七牛云的存储空间了。</p> <p><strong>PS</strong>：上传到七牛云时，七牛云需要创建对应的存储空间。<br> <strong>PS</strong>：除了安装 MongoDB，也可以安装 Mysql。<br> <img src="/images/server-build/%E5%AE%89%E8%A3%85mysql.jpg" alt="安装mysql"></p> <p>好了，经过这么多步骤，服务器配置宣告结束！终于进入项目部署阶段了！</p> <h2 id="项目部署"><a href="#项目部署" class="header-anchor">#</a> 项目部署</h2> <p>之前我们已经提到过可以用 pm2 进行Node项目的部署，这里不使用 <code>pm2 start app.js</code> 这种方法来进行部署，输入 <code>pm2 delete app.js</code> 删除这个测试用例。<br>
我们使用配置文件来 <strong>远程部署</strong> 项目，即本地通知服务器去拉取项目并部署。</p> <p>首先我们在要在本地安装 pm2，然后在要部署的项目的根目录下创建 <code>ecosystem.json</code> 文件，然后输入如下配置：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// 应用信息</span>
  <span class="token property">&quot;apps&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MusicServer&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 项目名称</span>
      <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token string">&quot;app.js&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 执行入口</span>
      <span class="token property">&quot;watch&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否监听</span>
      <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 默认环境</span>
        <span class="token property">&quot;NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;development&quot;</span> <span class="token comment">// 环境变量</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;env_production&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 自定义环境，输入 --env production  来使用</span>
         <span class="token property">&quot;NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span> <span class="token comment">// 环境变量</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 部署信息</span>
  <span class="token property">&quot;deploy&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;production&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 部署方法名</span>
      <span class="token property">&quot;user&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xxxxx&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 服务器上的管理员名字</span>
      <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;xxx.xx.xx.x&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 公网IP</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xxxxx&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 端口</span>
      <span class="token property">&quot;ref&quot;</span><span class="token operator">:</span> <span class="token string">&quot;origin/master&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 远程代码分支</span>
      <span class="token property">&quot;repo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;git@gitlab.com:xxxx.git&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 远程代码地址</span>
      <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/www/website/music-server&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 部署的路径</span>
      <span class="token property">&quot;ssh_options&quot;</span><span class="token operator">:</span> <span class="token string">&quot;StrictHostKeyChecking=no&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 不检查host key</span>
      <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 部署时的环境，默认会被应用的 env_production 覆盖，原因见文档的 post-deploy 字段</span>
        <span class="token property">&quot;NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span> <span class="token comment">// 环境变量</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="http://pm2.keymetrics.io/docs/usage/deployment/" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
由上可知我们的部署路径是在根目录下的 www/website 文件夹中，我们在服务器终端中 <code>cd /</code> 进入根目录，然后创建文件夹。<br>
接着保存配置文件并输入 <code>pm2 deploy ecosystem.json production(部署方法名) setup(建立远程连接)</code> 来启动部署。</p> <p>部署时我们发现有 <code>mkdir: cannot create directory ‘/www/website/music-server’: Permission denied</code> 的错误。<br>
这是因为我们的角色没有操作权限(root有，但已被封印)，此时我们需要进行降权操作。</p> <p>这里我们降权 website 这个文件夹，输入 <code>sudo chmod 777 -R website</code> 来使该文件夹下我们的角色可以进行增删操作。<br>
OK，再次输入 <code>pm2...</code> 这个命令，部署完成。</p> <p>部署完成后在服务器端我们可以发现 website 下多了我们的项目文件夹，里面包含了三个子文件夹，分别代表了：<br> <strong>current</strong>：当前服务运行的文件夹<br> <strong>shared</strong>：日志等其他共享文件<br> <strong>source</strong>：项目源代码</p> <p>现在我们来发布项目，输入 <code>pm2 deploy ecosystem.json production(部署方法名)</code> 可发布项目。<br>
然而又报错了= =  <code>pm2: command not found</code>，原因是 pm2 没有开启 ssh 远程交互模式，所以没法调用服务器那头的 pm2，我们来更改一下配置吧。<br>
回到角色根目录 <code>cd</code> ， <code>vi .bashrc</code> 打开文件，把 <code>If not running...</code> 下的四行代码注释掉并保存。<br>
重新加载它 <code>source .bashrc</code>。<br>
然后重新发布。<br>
发现又报错了，原来是本地的 <strong>ecosystem.json</strong> 得提交到远程服务器啊，让我们提交后再试一次。</p> <p>我们这次就发布成功了，让我们在终端输入 <code>pm2 list</code> 查看状态。<br>
此时有可能会出现 status errored，可以输入 <code>pm2 logs</code> 查看日志并进行项目调整。</p> <p>OK，项目发布成功后我们还得调整 nginx 和 iptables 的配置。<br>
因为这次发布的项目要关联域名，并且项目是监听 3000 端口的，我们需要允许这个端口开放。</p> <p>nginx 修改的地方就是将 <code>server_name</code> 的值改为域名。<br>
iptables 修改的地方就是添加如下代码，允许 3000 端口的输入输出：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># accept 3000 port entry and output</span>
<span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-s</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> tcp --destination-port <span class="token number">3000</span> <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> NEW,ESTABLISHED <span class="token parameter variable">-j</span> ACCEPT
<span class="token parameter variable">-A</span> OUTPUT <span class="token parameter variable">-d</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> tcp --destination-port <span class="token number">3000</span> <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> ESTABLISHED <span class="token parameter variable">-j</span> ACCEPT
</code></pre></div><p>当进行多个项目发布时，同理。<br>
这样，我们的项目就能用域名访问啦！</p> <p>当然，我们在部署时是分 开发环境(development) 和 生产环境(production) 的，MongoDB数据库的连接需要区分环境，<br>
开发时连接本地数据库，生产时连接服务器数据库，代码类似：<br> <img src="/images/server-build/MongoDB%E8%BF%9E%E6%8E%A5.jpg" alt="MongoDB连接"></p> <p>完结撒花！</p> <h2 id="番外1-ssl证书的获取与应用"><a href="#番外1-ssl证书的获取与应用" class="header-anchor">#</a> 番外1：SSL证书的获取与应用</h2> <p>由于小程序开发的域名只支持 https，因此 SSL 证书的申请就显得理所当然了。</p> <blockquote><p>PS：在小程序篇里我们使用自己的二级域名作为小程序的请求域，这个请求域代理了豆瓣的API。</p></blockquote> <p>证书一般分为三类：</p> <ol><li>DV：安全性一般，有免费的，有便宜的，用于个人博客、展示页面等。</li> <li>OV：安全性强，价格较高，用于电商网站、私密社交等。</li> <li>EV：安全性最高，价格非常高，用于金融支付、网上银行等。</li></ol> <p>这里我们使用免费的 DV 证书即可，<a href="https://console.cloud.tencent.com/ssl" target="_blank" rel="noopener noreferrer">申请地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。<br>
申请时：私钥密码不填、选择手动DNS验证。<br>
申请成功后，进入证书详情，按<a href="https://cloud.tencent.com/document/product/400/4142#1.-.E6.89.8B.E5.8A.A8dns.E9.AA.8C.E8.AF.81" target="_blank" rel="noopener noreferrer">要求<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>添加解析记录。<br>
随后回到详情页点击检测。<br>
检测成功后我们就可以下载证书了。</p> <p>证书包下载后解压，打开终端，输入 <code>scp -P 39999 ./1_xxx_bundle.crt manager@xxx:/home/manager/</code> 把 .crt 和 .key 文件上传到根目录。<br>
上传完成后，我们建立一个 ssl 文件夹，把这俩文件放进去 <code>mkdir ssl</code> <code>mv 1_* ./ssl/</code> <code>mv 2_* ./ssl/</code>。<br>
然后把 ssl 文件夹放到 /www/ 下面 <code>mv ssl /www/</code>。</p> <p>接着我们进入证书详情页，点击<a href="https://www.qcloud.com/doc/product/400/%E8%AF%81%E4%B9%A6%E5%AE%89%E8%A3%85%E6%8C%87%E5%BC%95" target="_blank" rel="noopener noreferrer">指引文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，把 Nginx 下的 server 配置复制，location 代码不复制。<br>
然后我们进入 nginx 的配置文件夹，新建配置文件(xx-xxx-xx.conf)，将代码复制进去，根据情况进行修改。<br>
复制<a href="https://www.zhihu.com/question/265806694" target="_blank" rel="noopener noreferrer">豆瓣Nginx转发<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的 location 代码到配置文件中，保存。<br>
最终配置如下：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> xxxx.xxxxxx.cn</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://xxxx.xxxxxx.cn<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span> <span class="token comment"># 如果是以 http://... 的形式访问，就重定向到 https://...</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> xxxx.xxxxxx.cn</span><span class="token punctuation">;</span> <span class="token comment">#填写绑定证书的域名</span>
  <span class="token directive"><span class="token keyword">ssl</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">ssl_certificate</span> /www/ssl/1_xxxx.xxxxxx.cn_bundle.crt</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /www/ssl/2_xxxx.xxxxxx.cn.key</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">ssl_session_timeout</span> <span class="token number">5m</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1 TLSv1.1 TLSv1.2</span><span class="token punctuation">;</span> <span class="token comment">#按照这个协议配置</span>
  <span class="token directive"><span class="token keyword">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE</span><span class="token punctuation">;</span><span class="token comment">#按照这个套件配置</span>
  <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">location</span> /v2/</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_store</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Referer <span class="token string">'no-referrer-when-downgrade'</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> User-Agent <span class="token string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36'</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_connect_timeout</span> <span class="token number">600</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">600</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_send_timeout</span> <span class="token number">600</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> https://api.douban.com/v2/</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后 <code>sudo nginx -t</code> <code>sudo nginx -s reload</code>。<br>
最后，添加对应的二级域名的解析。<br>
完成！</p> <h2 id="番外2-连接远程数据库"><a href="#番外2-连接远程数据库" class="header-anchor">#</a> 番外2：连接远程数据库</h2> <p>数据库可视化工具(Robomongo 等)如何连接远程数据库？尤其是使用了 Nginx 的情况下？<br>
如果单单是前者，那么 so easy，工具要输入 IP 和 port，必要时输入 用户名 和 密码 就可以了。<br>
但如果加上后者呢？<br>
当我想当然的弄了个二级域名，用它指向远端本地数据库，以为连上这个域名就能转接到数据库时...哦呼，似乎不行呢，提示了个 <code>recv(): message len 1347703880 is invalid. Min 16 Max: 48000000</code> 的错误了呢，这是咋回事呢？<br>
原因是数据库连接需要使用 <strong>流数据</strong> 的方式，也就是说，数据库连接不能直接用 nginx 启动一个 server 来完成，因为这个 server 使用的是 http 的方式，我们需要用 stream 的方式来建立 server。<br>
详细解决方案见：<a href="https://stackoverflow.com/questions/31853755/how-to-setup-mongodb-behind-nginx-reverse-proxy" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>该方案有几个要点：</p> <ol><li>利用 stream 建立 server</li> <li>stream 中的 server 不支持 server_name</li> <li>stream 模块与 http 模块同级</li> <li>不要将 stream 放入 /etc/nginx/conf.d/xx.conf 中，而应该将其放入 /etc/nginx/nginx.conf 中，因为 conf.d 中的所有配置都是以 http 的方式启动的，且放在该目录下的配置文件，如果包含 stream，那么意味着 http { stream {...} ... }，违反了同级的规定，会报错(可以打开配置文件自己瞅瞅)</li> <li>iptables 的端口权限需要设置</li></ol> <p>跟着党走，配置后的信息如下：<br> <img src="/images/server-build/stream%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE.jpg" alt="stream模块配置"><br>
完成！</p> <h2 id="番外3-连接远程服务器"><a href="#番外3-连接远程服务器" class="header-anchor">#</a> 番外3：连接远程服务器</h2> <p>上面是连接数据库，现在是连接服务器。<br>
我们可以使用 FileLizza 来连接，它可以简化一些操作(比如：新建、删除、移动等)<br>
默认情况下它使用的是 ftp 连接，但由于我们使用的是 ssh 密钥的方式，属于 sftp 连接，所以需要更改一下软件设置：<br>
文件 -&gt; 站点管理器 -&gt; 新建 -&gt; sftp模式 -&gt; 传密钥 -&gt; 连接 -&gt; 搞定</p> <p>另外，这里提一下 “杀线程” 方法，顾名思义，停止某个线程使用，释放端口：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">lsof</span> <span class="token parameter variable">-i:4000</span> <span class="token comment"># 检查某个端口的使用情况</span>
<span class="token function">kill</span> <span class="token parameter variable">-9</span> <span class="token number">4000</span> <span class="token comment"># 杀掉线程</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/9/2023, 7:46:43 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/KokoTa_Home/front/JS精度问题.html" class="prev">
        JS精度问题
      </a></span> <span class="next"><a href="/KokoTa_Home/front/前端问题汇总.html">
        前端问题汇总
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/KokoTa_Home/assets/js/app.5aa2fc63.js" defer></script><script src="/KokoTa_Home/assets/js/2.f316d9e6.js" defer></script><script src="/KokoTa_Home/assets/js/21.189a1078.js" defer></script>
  </body>
</html>
